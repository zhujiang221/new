# 宠物医院管理系统数据库设计（新旧版本对照，基于 v1.0.8）

> 本文用于论文撰写：在**旧版（2.2.3）数据需求描述**基础上，结合当前项目 `PetHospitalSys-v1.0.8` 的实际数据库结构（以 `Pet Hospital Management System Backend/src/main/resources/mysql/newphms.sql` 与 `dump-phms-202601170511.sql` 为准）完成字段/实体的补充与更替说明。

---

## 1. 数据库与中间件配置（现行版本）

- **MySQL**：数据库名 `phms`（配置来源：`Pet Hospital Management System Backend/src/main/resources/application.yml`）
  - `jdbc:mysql://localhost:3306/phms?useUnicode=true&characterEncoding=utf8&serverTimezone=UTC&useSSL=false&allowPublicKeyRetrieval=true`
  - 用户名：`root`，密码：`123456`
- **Redis**：`localhost:6379`（用于缓存/会话等，项目提供 Windows 启停脚本）
- **后端端口**：`8186`

> 说明：项目采用 MyBatis + Druid 连接池；表间关系大多通过业务逻辑与字段关联实现，**当前 SQL 脚本中未显式声明外键**（论文可描述为“逻辑外键/关联字段”）。

---

## 2. 旧版数据需求与现行数据库的主要差异（必须在论文中修正的点）

### 2.1 用户（user）

- **旧版描述**：密码“加密存储（MD5加密）”。
- **现行实现**：密码字段 `user.password` 存储的是 **MD5 摘要值（哈希）**（代码中使用 `MD5.md5(...)` 生成）。
  - 论文建议表述：**“密码采用 MD5 哈希摘要存储（非可逆加密）”**。

### 2.2 宠物（pet）

- **旧版描述包含**：品种、年龄等字段。
- **现行数据库**：`pet` 表不包含“品种(breed)”与“年龄(age)”字段；以 `birthday`（出生日期）为主，在业务上可由生日计算年龄。
  - 论文修正建议：把“年龄”改为“出生日期（可推算年龄）”；“品种”在当前版本未建模（若论文必须保留，可在“扩展设计”中作为未来字段）。

### 2.3 预约（appointment）与预约状态

- **旧版描述**：待处理/已同意/已拒绝/已完成等状态。
- **现行代码约定（以医生端展示逻辑为准）**：
  - `1`：待就诊
  - `2`：进行中
  - `3`：已完成
  - `4`：已取消

> 说明：现行数据库没有“已拒绝/已同意”的独立状态字面量，论文应以当前实现为准；如需解释“医生处理”，可描述为从“待就诊”流转至“进行中/已取消/已完成”等。

### 2.4 诊断（diagnosis）与用药建议/治疗方案

- **旧版描述包含**：治疗方案、用药建议等字段。
- **现行数据库**：
  - `diagnosis` 表仅保留诊断核心：`info/type/status/create_time` 等。
  - “用药建议/处方”改由 `medicine_record` 表承载，并通过 `medicine_record.diagnosis_id` 关联到诊断记录。
  - 论文修正建议：将“用药建议”从 `diagnosis` 实体拆分为“处方/用药记录（medicine_record）”实体。

### 2.5 健康指南（旧版称“健康指南”/“健康知识”）

- **旧版描述包含**：作者ID（医生）、分类标签等字段。
- **现行数据库**：对应表为 `notice`，字段只有 `id/title/content/view_count/create_time`，**无作者ID、无标签分类**。
  - 论文修正建议：将“健康指南”实体按当前实现写为“公告/健康指南（notice）”；作者与标签作为后续扩展点说明即可。

### 2.6 新增实体（旧版未覆盖或未强调）

现行版本新增/强化了以下表（旧版论文段落中建议补充）：

- `api_log`：接口调用日志（URL、方法、参数、响应、耗时、状态、用户ID等）
- `doctor_schedule`：医生排班（周几、时间段、最大预约数、启用状态）
- `doctor_service_type`：医生可提供的预约/服务类型（医生与 `appointment_type` 的关联）
- `notification_message`：预约消息提醒（用于医生端通知/广播）
- `chat_request` / `chat_session` / `chat_message`：医患聊天申请、会话与消息

---

## 3. 现行版本数据库概念结构（实体与关系）

### 3.1 核心实体清单（现行版本）

- 用户：`user`
- 宠物：`pet`
- 预约：`appointment`
- 预约类型：`appointment_type`
- 医生排班：`doctor_schedule`
- 医生服务类型：`doctor_service_type`
- 诊断：`diagnosis`
- 药品：`medicine`
- 用药/处方记录：`medicine_record`
- 宠物日志：`pet_daily`
- 健康指南/公告：`notice`
- 预约消息提醒：`notification_message`
- 聊天申请：`chat_request`
- 聊天会话：`chat_session`
- 聊天消息：`chat_message`
- 接口日志：`api_log`

### 3.2 主要关系（逻辑外键）

- `pet.user_id` → `user.id`
- `appointment.pet_id` → `pet.id`
- `appointment.user_id` → `user.id`
- `appointment.doctor_id` → `user.id`（医生，`user.role=2`）
- `appointment.appointment_type_id` → `appointment_type.id`
- `doctor_schedule.doctor_id` → `user.id`（医生）
- `doctor_service_type.doctor_id` → `user.id`（医生）
- `doctor_service_type.type_id` → `appointment_type.id`
- `diagnosis.pet_id/user_id/doctor_id` → 对应主表
- `medicine.create_by` → `user.id`（医生/管理员）
- `medicine_record.diagnosis_id` → `diagnosis.id`（处方关联诊断）
- `medicine_record.medicine_id` → `medicine.id`
- `notification_message.receiver_id` → `user.id`（医生）
- `chat_request.user_id/doctor_id` → `user.id`
- `chat_session.user_id/doctor_id` → `user.id`
- `chat_session.request_id` → `chat_request.id`
- `chat_message.session_id` → `chat_session.id`
- `api_log.user_id` → `user.id`

---

## 4. 数据库逻辑结构（现行表结构字典，论文可直接引用）

> 字段类型与含义来源：`newphms.sql` 与最新 dump；以下为论文可读化整理（与实际字段保持一致）。

### 4.1 用户表 `user`

| 字段名 | 类型 | 含义/说明 |
|---|---|---|
| id | bigint(20) unsigned | 主键，自增 |
| username | varchar(100) | 用户名（非空） |
| password | varchar(255) | 密码 MD5 哈希摘要值 |
| role | int(11) | 角色（1=管理员，2=医生，3=用户） |
| name | varchar(255) | 姓名/证件姓名（项目沿用字段） |
| age | int(11) | 年龄（可空） |
| email | varchar(255) | 邮箱 |
| phone | varchar(255) | 手机号 |
| address | varchar(255) | 地址 |
| img | varchar(255) | 头像 |
| info | varchar(255) | 个人简介 |
| id_card | varchar(255) | 身份证号（医生相关信息可空） |
| id_name | varchar(255) | 证件姓名（可空） |
| qualification | varchar(255) | 资质证书（可空） |
| hospital_name | varchar(255) | 医院名称（可空） |
| hospital_address | varchar(255) | 医院地址（可空） |
| department | varchar(255) | 科室（可空） |
| create_time | datetime | 创建时间 |

### 4.2 宠物表 `pet`

| 字段名 | 类型 | 含义/说明 |
|---|---|---|
| id | bigint(20) unsigned | 主键，自增 |
| user_id | bigint(20) | 所属用户ID（逻辑外键） |
| name | varchar(255) | 宠物名称 |
| type | varchar(255) | 宠物类型（如犬/猫；当前用字符串） |
| birthday | datetime | 出生日期（可推算年龄） |
| weight | double(10,2) | 体重 |
| height | double(10,2) | 身高 |
| sex | varchar(100) | 性别 |
| img | varchar(255) | 图片路径 |
| create_time | datetime | 创建时间 |

### 4.3 预约类型表 `appointment_type`

| 字段名 | 类型 | 含义/说明 |
|---|---|---|
| id | bigint(20) unsigned | 主键，自增 |
| name | varchar(50) | 类型名称（看病/疫苗/洗澡/修毛等） |
| description | varchar(255) | 描述 |
| status | tinyint(1) | 状态（0=禁用，1=启用） |
| create_time | datetime | 创建时间 |

### 4.4 医生排班表 `doctor_schedule`

| 字段名 | 类型 | 含义/说明 |
|---|---|---|
| id | bigint(20) unsigned | 主键，自增 |
| doctor_id | bigint(20) | 医生ID（逻辑外键） |
| week_day | tinyint(1) | 星期几（1-7，1=周一） |
| time_slot | varchar(20) | 时间段（如09:00-10:00） |
| max_appointments | int(11) | 最大可预约数（默认5） |
| status | tinyint(1) | 状态（0=停用，1=启用） |
| create_time | datetime | 创建时间 |
| update_time | datetime | 更新时间 |

### 4.5 医生服务类型表 `doctor_service_type`

| 字段名 | 类型 | 含义/说明 |
|---|---|---|
| id | bigint(20) unsigned | 主键，自增 |
| doctor_id | bigint(20) | 医生ID |
| type_id | bigint(20) | 预约/服务类型ID（关联 appointment_type） |
| create_time | datetime | 创建时间 |

> 约束：`(doctor_id, type_id)` 唯一（同一医生同一类型只能绑定一次）。

### 4.6 预约表 `appointment`

| 字段名 | 类型 | 含义/说明 |
|---|---|---|
| id | bigint(20) unsigned | 主键，自增 |
| pet_id | bigint(20) | 宠物ID |
| user_id | bigint(20) | 用户ID |
| doctor_id | bigint(20) | 医生ID |
| appointment_type_id | bigint(20) | 预约类型ID |
| app_time | datetime | 预约日期/时间（项目中常配合 time_slot 表示具体时段） |
| time_slot | varchar(20) | 预约时间段（如09:00-10:00） |
| info | varchar(255) | 预约说明/描述 |
| phone | varchar(255) | 联系电话 |
| address | varchar(255) | 地址 |
| status | int(5) | 状态（1待就诊/2进行中/3已完成/4已取消） |
| create_time | datetime | 创建时间 |

### 4.7 诊断表 `diagnosis`

| 字段名 | 类型 | 含义/说明 |
|---|---|---|
| id | bigint(20) unsigned | 主键，自增 |
| pet_id | bigint(20) | 宠物ID |
| user_id | bigint(20) | 用户ID |
| doctor_id | bigint(20) | 医生ID |
| info | varchar(255) | 诊断信息/结果描述 |
| type | int(5) | 病情类型（项目用数字编码） |
| status | int(5) | 诊断状态（项目用数字编码） |
| create_time | datetime | 诊断时间 |

### 4.8 药品表 `medicine`

| 字段名 | 类型 | 含义/说明 |
|---|---|---|
| id | bigint(20) unsigned | 主键，自增 |
| name | varchar(255) | 药品名称（非空） |
| type | varchar(255) | 药品类型 |
| description | varchar(255) | 描述 |
| price | double(10,2) | 价格 |
| stock | int(11) | 库存（默认0） |
| status | int(5) | 状态（默认1） |
| create_time | datetime | 创建时间 |
| create_by | bigint(20) | 创建人ID |

### 4.9 用药/处方记录表 `medicine_record`

| 字段名 | 类型 | 含义/说明 |
|---|---|---|
| id | bigint(20) unsigned | 主键，自增 |
| pet_id | bigint(20) | 宠物ID |
| user_id | bigint(20) | 用户ID |
| doctor_id | bigint(20) | 医生ID |
| medicine_id | bigint(20) | 药品ID |
| quantity | int(11) | 数量 |
| dosage | varchar(255) | 剂量 |
| usage | varchar(255) | 用法 |
| create_time | datetime | 创建时间 |
| diagnosis_id | bigint(20) | 诊断ID（用于关联诊断） |

### 4.10 宠物日志表 `pet_daily`

| 字段名 | 类型 | 含义/说明 |
|---|---|---|
| id | bigint(20) unsigned | 主键，自增 |
| pet_id | bigint(20) | 宠物ID |
| user_id | bigint(20) | 用户ID |
| temperature | double(10,2) | 体温 |
| weight | double(10,2) | 体重 |
| height | double(10,2) | 身高 |
| appetite | double(10,2) | 食欲 |
| status | int(5) | 健康状态（项目用数字编码） |
| create_time | datetime | 记录时间 |

### 4.11 健康指南/公告表 `notice`（旧版“健康指南”现行落表）

| 字段名 | 类型 | 含义/说明 |
|---|---|---|
| id | bigint(20) unsigned | 主键，自增 |
| title | varchar(255) | 标题 |
| content | varchar(255) | 内容（项目中常存 HTML 字符串/片段） |
| view_count | bigint(20) | 浏览次数 |
| create_time | datetime | 发布时间 |

> 注意：当前版本**无作者ID、无分类标签**字段。

### 4.12 健康标准表 `standard`

| 字段名 | 类型 | 含义/说明 |
|---|---|---|
| id | bigint(20) unsigned | 主键，自增 |
| age_min | int(10) | 最小年龄 |
| age_max | int(10) | 最大年龄 |
| temp_min | double(10,2) | 最低体温 |
| temp_max | double(10,2) | 最高体温 |
| weight_min | double(10,2) | 最低体重 |
| weight_max | double(10,2) | 最高体重 |
| height_min | double(10,2) | 最低身高 |
| height_max | double(10,2) | 最高身高 |
| appetite_min | double(10,2) | 最低食欲值 |
| appetite_max | double(10,2) | 最高食欲值 |
| type | varchar(255) | 宠物类型 |
| status | int(5) | 标准状态 |

### 4.13 预约消息提醒表 `notification_message`

| 字段名 | 类型 | 含义/说明 |
|---|---|---|
| id | bigint(20) | 主键，自增 |
| receiver_id | bigint(20) | 接收者（医生ID） |
| sender_id | bigint(20) | 发送者（用户ID，可空） |
| appointment_id | bigint(20) | 预约ID（可空，广播时可能为空） |
| type | varchar(50) | 消息类型（如 APPOINTMENT / BROADCAST） |
| title | varchar(200) | 标题 |
| content | text | 内容（JSON字符串） |
| is_read | tinyint(1) | 是否已读（0/1） |
| create_time | timestamp | 创建时间 |

### 4.14 聊天申请表 `chat_request`

| 字段名 | 类型 | 含义/说明 |
|---|---|---|
| id | bigint(20) | 主键，自增 |
| user_id | bigint(20) | 用户ID |
| doctor_id | bigint(20) | 医生ID |
| status | tinyint(1) | 状态（0待审核/1同意/2拒绝） |
| request_message | varchar(500) | 申请留言 |
| create_time | timestamp | 创建时间 |
| update_time | timestamp | 更新时间 |

### 4.15 聊天会话表 `chat_session`

| 字段名 | 类型 | 含义/说明 |
|---|---|---|
| id | bigint(20) | 主键，自增 |
| user_id | bigint(20) | 用户ID |
| doctor_id | bigint(20) | 医生ID |
| request_id | bigint(20) | 申请ID（可空） |
| status | tinyint(1) | 状态（0关闭/1进行中） |
| last_message_time | timestamp | 最后消息时间 |
| create_time | timestamp | 创建时间 |

> 约束：`(user_id, doctor_id)` 唯一，保证用户与医生只有一个会话。

### 4.16 聊天消息表 `chat_message`

| 字段名 | 类型 | 含义/说明 |
|---|---|---|
| id | bigint(20) | 主键，自增 |
| session_id | bigint(20) | 会话ID |
| sender_id | bigint(20) | 发送者ID |
| receiver_id | bigint(20) | 接收者ID |
| message_type | varchar(20) | 消息类型（text/emoji/image/file） |
| content | text | 内容（文本或文件路径） |
| is_read | tinyint(1) | 是否已读（0/1） |
| is_revoked | tinyint(1) | 是否撤回（0/1） |
| create_time | timestamp | 创建时间 |

### 4.17 接口日志表 `api_log`

| 字段名 | 类型 | 含义/说明 |
|---|---|---|
| id | bigint(20) unsigned | 主键，自增 |
| request_url | varchar(255) | 请求URL |
| request_method | varchar(20) | 请求方法 |
| request_params | text | 请求参数（Query等） |
| request_body | text | 请求体 |
| response_status | int(5) | 响应状态码 |
| response_body | text | 响应体 |
| error_message | text | 错误信息 |
| ip_address | varchar(50) | IP地址 |
| user_agent | varchar(255) | UA |
| execute_time | bigint(20) | 执行耗时（ms） |
| status | int(5) | 调用状态（1成功/0失败） |
| create_time | datetime | 创建时间 |
| user_id | bigint(20) | 用户ID |

---

## 5. 与系统功能模块的对应关系（论文写作建议）

- **注册/登录/认证**：`user`（`password` 为 MD5 哈希摘要）
- **宠物档案/宠物管理**：`pet`
- **预约管理（用户侧）**：`appointment` + `appointment_type` + `doctor_schedule` + `doctor_service_type`
- **预约处理（医生侧）**：`appointment.status` 状态流转 + `notification_message`（通知）
- **诊断记录**：`diagnosis`（诊断描述）+ `medicine_record`（用药/处方）
- **宠物日志**：`pet_daily`
- **健康标准与健康评估**：`standard`
- **健康指南**：`notice`（当前版本为公告式指南，无作者/标签）
- **统计分析**：以预约/日志/处方等表聚合统计（例如：按 `appointment.app_time`、`pet_daily.create_time`）
- **聊天沟通**：`chat_request`/`chat_session`/`chat_message`
- **系统运维/审计**：`api_log`

---

## 6. 可选的论文“扩展设计”说明（非现行实现）

若论文需保留旧版概念但当前库未实现，建议在“扩展设计/未来工作”中描述：

- 宠物“品种(breed)”字段与标准化字典表
- 健康指南“作者ID/分类标签/分类表”
- 诊断“治疗方案”独立字段或“诊疗记录详情表”
- 外键约束与级联策略（当前为逻辑外键，可按规范化升级）

